<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å¹¸ç¦æŸ‘ä»”åº— - æœ€çµ‚ä¿®æ­£ç‰ˆ (V19.2)</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        /* --- GAS Mobile Fix Start --- */
        html, body { 
            position: fixed; 
            top: 0; left: 0; right: 0; bottom: 0;
            width: 100%; height: 100%;
            margin: 0; padding: 0; 
            background-color: #2d3748; 
            font-family: 'Noto Sans TC', sans-serif; 
            overflow: hidden; 
            overscroll-behavior: none; 
        }

        #mobile-container {
            width: 100%; 
            height: 100%; 
            max-width: 480px;
            margin: 0 auto; 
            background: #000; 
            position: relative; 
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }
        /* --- GAS Mobile Fix End --- */

        /* èƒŒæ™¯å±¤ */
        #bg-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover; background-position: center;
            transition: opacity 0.5s ease;
            background-color: #333; z-index: 1;
        }

        /* é›™ç·©è¡è§’è‰²å±¤ */
        #char-container {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
        }
        .char-img {
            position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
            max-height: 85%; width: auto; max-width: 95%; 
            opacity: 0; 
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.4));
            transition: opacity 0.4s ease-in-out; 
        }
        .char-visible { opacity: 1; }
        .object-mode { bottom: 25% !important; max-height: 45% !important; }

        /* HUD */
        #top-hud {
            position: absolute; top: 0; left: 0; width: 100%; padding: 15px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            color: white; z-index: 20; display: flex; justify-content: space-between;
            pointer-events: none;
        }
        .status-pill {
            background: rgba(255,255,255,0.15); backdrop-filter: blur(5px);
            padding: 8px 16px; border-radius: 25px; font-size: 16px; font-weight: bold;
            border: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; gap: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* éŸ³æ¨‚é–‹é—œ */
        #music-toggle {
            position: absolute; top: 15px; right: 15px; z-index: 50;
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(0,0,0,0.6); border: 2px solid rgba(255,255,255,0.5);
            color: white; font-size: 18px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            pointer-events: auto; transition: all 0.2s;
        }
        #music-toggle:active { transform: scale(0.9); background: rgba(0,0,0,0.8); }
        .music-off { color: #aaa; border-color: #555 !important; }

        /* å°è©±æ¡† */
        #dialog-area {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 38%;
            background: linear-gradient(to top, rgba(0,0,0,0.95), rgba(0,0,0,0.85) 85%, transparent);
            padding: 25px; padding-top: 45px; color: white; z-index: 30;
            display: flex; flex-direction: column; cursor: pointer;
        }
        #speaker-box {
            align-self: flex-start; background: #f6ad55; color: #2d3748;
            padding: 6px 18px; border-radius: 8px; font-weight: bold; font-size: 20px; margin-bottom: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); transform: translateY(-5px);
            display: flex; align-items: center; gap: 10px;
        }
        .read-btn {
            background: rgba(255,255,255,0.3); color: #2d3748; border-radius: 50%;
            width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
            font-size: 14px; cursor: pointer;
        }
        #dialog-text { 
            font-size: 22px; line-height: 1.6; flex: 1; overflow-y: auto; 
            text-shadow: 0 1px 2px rgba(0,0,0,0.8); white-space: pre-wrap; word-break: break-all;
        }
        .next-arrow { position: absolute; bottom: 25px; right: 25px; color: #f6ad55; animation: bounce 1s infinite; font-size: 28px; }

        /* äº’å‹•å±¤ */
        #interaction-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(10px);
            z-index: 100; display: none;
            flex-direction: column; justify-content: center; align-items: center; padding: 20px;
        }
        #interaction-title {
            color: white; font-size: 24px; font-weight: bold; text-align: center; margin-bottom: 25px;
            background: rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; width: 100%;
            border: 1px solid rgba(255,255,255,0.2); display: flex; justify-content: space-between; align-items: center;
        }
        .title-speak-btn {
            background: rgba(255,255,255,0.2); width: 32px; height: 32px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }

        /* é¸æ“‡æŒ‰éˆ• */
        .choice-btn {
            background: white; color: #2d3748; width: 100%; padding: 20px; margin-bottom: 16px;
            border-radius: 16px; border: none; font-size: 20px; font-weight: bold;
            box-shadow: 0 4px 0 #cbd5e0; transition: transform 0.1s;
            display: flex; justify-content: space-between; align-items: center; cursor: pointer;
        }
        .choice-btn:active { transform: translateY(4px); box-shadow: none; background: #e2e8f0; }
        .choice-speak-icon {
            background: #e2e8f0; width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; color: #4a5568;
            margin-right: 15px; z-index: 10;
        }

        /* è¼¸å…¥ä»‹é¢ - ä¿®æ­£ç‰ˆ */
        .input-group { 
            display: flex; gap: 4px; /* ç¸®å°é–“è· */
            margin-bottom: 25px; width: 100%; justify-content: center; 
        }
        .custom-select {
            padding: 10px 0; /* ç¸®å° padding é˜²æ­¢è·‘ç‰ˆ */
            font-size: 18px; /* ç¨å¾®ç¸®å°å­—é«” */
            border-radius: 10px; border: 3px solid #f6ad55;
            background: #fff; color: #2d3748; font-weight: bold; text-align: center; 
            flex: 1; /* å¹³å‡åˆ†é… */
            width: 0; /* Flex hack for min width */
            min-width: 0; /* å…è¨±ç¸®å° */
        }
        .confirm-btn {
            background: #48bb78; color: white; padding: 18px 40px; border-radius: 50px;
            font-size: 24px; font-weight: bold; border: none; cursor: pointer;
            box-shadow: 0 6px 0 #2f855a; width: 100%; margin-top: 15px;
        }
        .confirm-btn:active { transform: translateY(4px); box-shadow: none; }

        /* Numpad */
        #numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; width: 100%; margin-bottom: 20px; }
        .num-btn {
            background: rgba(255,255,255,0.15); color: white; border: 2px solid rgba(255,255,255,0.3);
            padding: 20px; font-size: 26px; font-weight: bold; border-radius: 12px; cursor: pointer;
        }
        .num-btn:active { background: rgba(255,255,255,0.4); transform: scale(0.95); }
        #numpad-display {
            width: 100%; background: #fff; color: #2d3748; font-size: 40px; font-weight: bold;
            text-align: center; padding: 15px; border-radius: 12px; margin-bottom: 25px;
            border: 4px solid #f6ad55; letter-spacing: 3px; height: 80px; display: flex; align-items: center; justify-content: center;
        }

        /* Time Picker */
        .time-picker-container {
            display: flex; flex-direction: column; align-items: center; width: 100%;
            background: white; border-radius: 20px; padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .ampm-toggle {
            display: flex; background: #e2e8f0; border-radius: 50px; padding: 5px; margin-bottom: 20px; width: 100%;
        }
        .ampm-btn {
            flex: 1; padding: 10px; border-radius: 40px; border: none; font-size: 20px; font-weight: bold;
            cursor: pointer; background: transparent; color: #718096; transition: all 0.2s;
        }
        .ampm-btn.active { background: #3b82f6; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .hour-selector {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; width: 100%;
        }
        .hour-btn {
            background: #f7fafc; border: 2px solid #e2e8f0; border-radius: 12px;
            padding: 15px 0; font-size: 24px; font-weight: bold; color: #2d3748;
            cursor: pointer; transition: all 0.2s;
        }
        .hour-btn.selected {
            border-color: #f6ad55; background: #fffaf0; color: #ed8936; box-shadow: 0 0 0 2px #f6ad55;
        }

        /* Intro & Report */
        #intro-overlay, #report-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 200; backdrop-filter: blur(5px);
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; text-align: center; color: white;
        }
        .intro-title { font-size: 40px; font-weight: bold; color: #f6ad55; margin-bottom: 25px; }
        .report-card {
            background: #fff; width: 100%; padding: 35px 25px; border-radius: 25px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.8); text-align: center; color: #2d3748;
        }
        .stamp {
            border: 5px solid #e53e3e; color: #e53e3e; border-radius: 15px;
            padding: 10px 25px; font-size: 32px; font-weight: bold;
            transform: rotate(-5deg); margin: 30px auto; display: inline-block;
        }
        #start-btn {
            background: linear-gradient(135deg, #f6ad55, #ed8936); color: #fff; border: none; 
            padding: 18px 70px; border-radius: 50px; font-size: 24px; font-weight: bold; 
            cursor: pointer; box-shadow: 0 6px 20px rgba(237, 137, 54, 0.4);
            transition: all 0.3s; width: 80%; text-align: center;
        }
        #start-btn:disabled { background: #718096; cursor: wait; animation: none; box-shadow: none; opacity: 0.8; }
        .pulse { animation: pulse 2s infinite; }
        #key-item {
            position: absolute; top: 60%; left: 70%; width: 100px; display: none; 
            z-index: 15; filter: drop-shadow(0 0 10px gold); cursor: pointer;
            animation: floatKey 2s infinite ease-in-out;
        }
        @keyframes floatKey { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(5px); } }
    </style>
</head>
<body>

    <div id="mobile-container">
        <!-- éŸ³æ¨‚ -->
        <audio id="bgm" loop preload="auto">
            <source src="https://tunes.stocktune.com/public/8/7/e/87e007c3-7502-426c-8e14-f2a014c9c66f/whispers-of-forgotten-memories-stocktune.mp3" type="audio/mpeg">
        </audio>

        <div id="music-toggle" onclick="toggleMusic()">
            <i class="fas fa-volume-up"></i>
        </div>

        <div id="bg-layer"></div>
        
        <div id="char-container">
            <img id="char-1" class="char-img" alt="Char1">
            <img id="char-2" class="char-img" alt="Char2">
        </div>
        
        <img id="key-item" src="" alt="Key">
        
        <div id="top-hud">
            <div class="status-pill"><i class="fas fa-clock"></i> <span id="game-time">08:00</span></div>
            <div style="flex:1;"></div>
            <div class="status-pill" style="margin-right: 50px;"><i class="fas fa-coins"></i> ç‡Ÿæ”¶: <span id="game-money">0</span></div>
        </div>
        
        <div id="dialog-area" onclick="advanceStory()">
            <div id="speaker-box">
                <span id="speaker-name">...</span>
                <div class="read-btn" onclick="event.stopPropagation(); replayVoice()"><i class="fas fa-volume-up"></i></div>
            </div>
            <div id="dialog-text">...</div>
            <div class="next-arrow"><i class="fas fa-caret-down"></i></div>
        </div>
        
        <div id="interaction-overlay">
            <div id="interaction-title">
                <span id="title-text">è«‹é¸æ“‡</span>
                <div class="title-speak-btn" onclick="speakTitle()"><i class="fas fa-volume-up"></i></div>
            </div>
            <div id="interaction-content" style="width:100%"></div>
        </div>

        <div id="intro-overlay">
            <div class="intro-title">å¹¸ç¦æŸ‘ä»”åº—</div>
            <div style="font-size:20px; line-height:1.8; color:#e2e8f0; margin-bottom:40px;">
                æ­¡è¿å…‰è‡¨ï¼<br>ä»Šå¤©æ‚¨å°‡åŒ–èº«ç‚º<b>ã€Œä¸€æ—¥åº—é•·ã€</b>ï¼Œ<br>è«‹ç™¼æ®æ‚¨çš„æ™ºæ…§èˆ‡ç¶“é©—ï¼Œ<br>è™•ç†æŸ‘ä»”åº—çš„å¤§å°äº‹å§ï¼
            </div>
            <button id="start-btn" onclick="startGame()" disabled>
                <i class="fas fa-spinner fa-spin"></i> éŠæˆ²è¼‰å…¥ä¸­...
            </button>
        </div>
        
        <div id="report-overlay" style="display:none;">
            <div class="report-card">
                <h2 style="margin:0;">ğŸ“… æœ¬æ—¥ç‡Ÿé‹æ—¥å ±</h2>
                <div style="font-size:16px; color:#718096; margin-bottom:20px;">å°åŒ—ç¸½åº—</div>
                <div id="final-stamp" class="stamp">...</div>
                <div style="display:flex; justify-content:space-between; border-bottom:1px dashed #ccc; padding:15px 0;">
                    <span>ç‡Ÿé‹ç©åˆ†</span><span id="report-money" style="font-weight:bold; color:#38a169; font-size:22px;">$0</span>
                </div>
                <div style="display:flex; justify-content:space-between; border-bottom:1px dashed #ccc; padding:15px 0;">
                    <span>å°ˆæ³¨åŠ›è©•ç´š</span><span id="report-risk" style="font-weight:bold; font-size:22px;">S ç´š</span>
                </div>
                <p id="report-advice" style="font-size:18px; margin-top:25px; text-align:left; background:#f7fafc; padding:20px; border-radius:15px; line-height:1.6;">...</p>
            </div>
            <button onclick="location.reload()" style="background:#4fd1c5; color:white; border:none; padding:18px 50px; border-radius:50px; font-size:22px; font-weight:bold; margin-top:30px; cursor:pointer;">æ˜æ—¥ç¹¼çºŒç‡Ÿæ¥­</button>
        </div>
    </div>

    <script>
        // ================= JS Fix for GAS =================
        function resizeApp() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
            document.getElementById('mobile-container').style.height = `${window.innerHeight}px`;
        }
        window.addEventListener('resize', resizeApp);
        
        // ================= ç´ æ =================
        const ASSETS = {
            bg_morning: "https://i.ibb.co/kVFN53b9/store-day.jpg",
            bg_noon: "https://i.ibb.co/kVFN53b9/store-day.jpg",
            bg_evening: "https://i.ibb.co/TqMpjG6D/store-dusk.jpg",
            bg_night: "https://i.ibb.co/WNzmf9SQ/store-night.jpg",
            bg_desktop: "https://i.ibb.co/xKSQWsNM/desktop.jpg",
            char_oldman: "https://i.ibb.co/v6PmHDZY/wang.png",
            char_delivery: "https://i.ibb.co/9mDg6DbQ/deliveryboy.png",
            char_customer: "https://i.ibb.co/sJJzGsbZ/mrschen.png", 
            char_tv: "https://i.ibb.co/GfTGhprQ/tv.png",
            char_keys: "https://i.ibb.co/6hhTndN/key.png",
            char_phone: "https://via.placeholder.com/300x300/transparent/000?text=Red+Phone",
            char_clock: "https://via.placeholder.com/300x300/transparent/000?text=Wall+Clock"
        };

        // ================= è²éŸ³è¨­å®š (Voice Tweaks) =================
        const VOICE_PROFILES = {
            "åº—é•·": { pitch: 1.0, rate: 1.0 },
            "æ—ç™½": { pitch: 1.0, rate: 1.1 },
            "è‚‰è²©å°åŠ‰": { pitch: 1.5, rate: 1.4 }, // è©é¨™ï¼Œå°–éŠ³æ€¥ä¿ƒ
            "ç±³åº—é˜¿å¼·": { pitch: 0.7, rate: 1.2 }, // ç”·è²ï¼Œä½æ²ˆæœ‰åŠ›
            "è€ç‹": { pitch: 0.6, rate: 0.8 }, // è€äººï¼Œéå¸¸ä½æ²ˆæ…¢é€Ÿ
            "é™³å¤ªå¤ª": { pitch: 1.4, rate: 1.1 }, // å¥³è²ï¼Œé«˜éŸ³
            "é›»è©±": { pitch: 1.0, rate: 1.0 }
        };

        // ================= åŠ‡æœ¬ (Renamed & Updated) =================
        const SCRIPT = [
            { type: "scene", bg: "bg_morning", time: "08:00" },
            { type: "talk", speaker: "åº—é•·", text: "æ—©å®‰ï¼åˆæ˜¯å……æ»¿æ´»åŠ›çš„ä¸€å¤©ã€‚", char: null },
            
            // Task 1
            { type: "talk", speaker: "åº—é•·", text: "é¦–å…ˆè¦æŠŠæ—¥æ›†æ’•åˆ°ä»Šå¤©... å’¦ï¼Ÿä»Šå¤©æ˜¯å¹¾è™Ÿï¼Ÿ", char: "char_clock" },
            { type: "date_input", text: "è«‹é¸æ“‡ä»Šæ—¥çš„æ­£ç¢ºæ—¥æœŸï¼š", correct: { money: 100, s: 0 }, wrong: { money: 0, s: 1 }, char: "char_clock" },
            
            // Task 2
            { type: "talk", speaker: "åº—é•·", text: "ä¹–ä¹–é€²è²¨äº†ï¼Œä½†å †å¾—äº‚ä¸ƒå…«ç³Ÿã€‚ä»¥å‰æˆ‘æœ€å–œæ­¡æ“ºæ•´é½Šäº†...", char: null },
            { type: "choice", text: "æ‚¨ç¾åœ¨çš„æƒ³æ³•æ˜¯ï¼Ÿ", choices: [{ t: "å†ç´¯ä¹Ÿè¦å¥½å¥½æ•´ç†ä¸€ä¸‹ï¼Œç”Ÿæ„æ‰æœƒå¥½", s: 0, money: 200 }, { t: "å¥½ç´¯å–”ï¼Œå·æ‡¶ä¸€ä¸‹ï¼Œç”Ÿæ„ä¸æœƒå·®å¤šå°‘", s: 1, money: 0 }], char: null },

            // Task 3
            { type: "talk", speaker: "æ—ç™½", text: "(éˆ´éˆ´éˆ´â€”â€” ç´…è‰²é›»è©±éŸ¿äº†)", char: "char_phone" },
            { type: "talk", speaker: "è‚‰è²©å°åŠ‰", text: "ã€è€é—†å¥½ï¼Œæˆ‘æ˜¯è‚‰è²©å°åŠ‰ï¼Œæˆ‘å€‘æœ‰é€²å£é«˜ç´šæ¾³æ´²ç‰›è‚‰è¶…ä¾¿å®œï¼ã€", char: "char_phone" },
            { type: "talk", speaker: "è‚‰è²©å°åŠ‰", text: "ã€å¤–é¢1æ–¤è¦ä¸€åƒå…ƒï¼Œæˆ‘é€™é‚Šåªè¦è³£ä¸€ç™¾å…ƒï¼Œæ‚¨å†è³£ä¸€æ–¤äº”ç™¾å…ƒçµ¦å®¢äººéƒ½é‚„è³ºéŒ¢ï¼ã€", char: "char_phone" },
            { type: "talk", speaker: "è‚‰è²©å°åŠ‰", text: "ã€è¦ä¸è¦å…ˆåŒ¯éŒ¢çµ¦æˆ‘è²·å€‹100æ–¤ï¼Œæˆ‘å†é¦¬ä¸Šå¯„çµ¦æ‚¨ï¼Ÿã€", char: "char_phone" },
            { type: "choice", text: "æ‚¨çš„åæ‡‰æ˜¯ï¼Ÿ", choices: [{ t: "å¥½åƒå¾ˆåˆ’ç®—ï¼é¦¬ä¸ŠåŒ¯æ¬¾ã€‚", s: 1, money: -500, reaction: {text: "åº—é•·: å¥½ï¼ŒåŒ¯éå»äº†ï¼æœŸå¾…ç‰›è‚‰... ä¸éå¿ƒè£¡æ€éº¼æ€ªæ€ªçš„ï¼Ÿ", speaker: "åº—é•·"} }, { t: "è½èµ·ä¾†æ˜¯è©é¨™ï¼Œç›´æ¥æ›æ–·ã€‚", s: 0, money: 500 }], char: "char_phone" },
            { type: "talk", speaker: "åº—é•·", text: "å‘¼... çœŸçš„è¦å°å¿ƒã€‚", char: null },

            // Task 3.5 (ä¼ç­† - é˜¿å¼·)
            { type: "talk", speaker: "æ—ç™½", text: "(éˆ´éˆ´éˆ´â€”â€” é›»è©±åˆéŸ¿äº†)", char: "char_phone" },
            { type: "talk", speaker: "ç±³åº—é˜¿å¼·", text: "ã€å–‚ï¼Ÿè€é—†å–”ï¼Œæˆ‘æ˜¯ç±³åº—é˜¿å¼·å•¦ï¼ä¸‹åˆ 4 é»æˆ‘æœƒéå»é€è²¨ï¼Œå…ˆè·Ÿä½ è¬›ä¸€è²ï¼ã€", char: "char_phone" },
            { type: "talk", speaker: "åº—é•·", text: "å¥½ï¼Œä¸‹åˆ 4 é»ï¼Œæˆ‘è¨˜ä½äº†ã€‚", char: null },

            // Task 4
            { type: "scene", bg: "bg_morning", time: "10:00" },
            { type: "talk", speaker: "æ—ç™½", text: "(è€ç‹æ–è‘—æ‰‡å­èµ°äº†é€²ä¾†)", char: "char_oldman" }, 
            { type: "talk", speaker: "è€ç‹", text: "åº—é•·æ—©å•Šï¼æ˜¨å¤©å¤©æ°£å¥½ï¼Œæˆ‘å»å…¬åœ’æ‰“äº†ä¸€å¥—å¤ªæ¥µæ‹³å–”ï¼", char: "char_oldman" },
            { type: "talk", speaker: "åº—é•·", text: "å¤ªæ¥µæ‹³ä¸éŒ¯å–”ï¼Œå°èº«é«”å¥½ã€‚", char: "char_oldman" },
            { type: "talk", speaker: "è€ç‹", text: "å˜¿å•Šï¼Œé‚„é‡åˆ°é™³åª½åª½ï¼ŒèŠäº†å¾ˆå¤šã€‚", char: "char_oldman" },
            { type: "choice", text: "æ‚¨æƒ³æ¥è‘—å•è€ç‹ä»€éº¼ï¼Ÿ", choices: [{ t: "æ˜¨å¤©ä½ å»å“ªè£¡é‹å‹•å•Šï¼Ÿ", s: 1, money: 0 }, { t: "é‚£å…¬åœ’æœ‰ä»€éº¼æ–°è®ŠåŒ–å—ï¼Ÿ", s: 0, money: 100 }], char: "char_oldman" }, 
            { type: "talk", speaker: "è€ç‹", text: "å“ˆå“ˆï¼Œå°±é‚£æ¨£å•¦ã€‚é‚£æˆ‘å…ˆèµ°äº†ï¼Œæ°æ°ï¼", char: "char_oldman" },
            { type: "talk", speaker: "æ—ç™½", text: "(è€ç‹æ®æ®æ‰‹é›¢é–‹äº†)", char: null }, 

            // Task 5
            { type: "scene", bg: "bg_noon", time: "12:00" },
            { type: "talk", speaker: "åº—é•·", text: "ä¸­åˆä¼‘æ¯çœ‹ä¸€ä¸‹æ–°èå¥½äº†... å“å‘€ï¼", char: "char_tv", object: true },
            { type: "talk", speaker: "æ—ç™½", text: "(é›»è¦–ç•«é¢è®Šæˆäº†é›ªèŠ±é›œè¨Š)", char: "char_tv", object: true },
            { type: "choice", text: "é€šå¸¸æ‚¨æœƒæ€éº¼åšï¼Ÿ", choices: [{ t: "æª¢æŸ¥è¨Šè™Ÿç·šæ¥é ­", s: 0, money: 150 }, { t: "ç”¨åŠ›æ‹æ‰“é›»è¦–", s: 1, money: 0, reaction: {text: "åº—é•·: å“å”·ï¼æ‰‹å¥½ç—›... é€™ç¨®è€é›»è¦–æ‹äº†ä¹Ÿæ²’ç”¨ï¼Œæ‡‰è©²æ˜¯è¦æª¢æŸ¥è¨Šè™Ÿç·šæ‰å°ã€‚", speaker: "åº—é•·"} }], char: "char_tv", object: true }, 
            { type: "talk", speaker: "åº—é•·", text: "ä¿®å¥½äº†ï¼æœç„¶æ˜¯ç·šé¬†äº†ã€‚", char: null }, 

            // Task 6
            { type: "talk", speaker: "é™³å¤ªå¤ª", text: "è€é—†çµå¸³ï¼æˆ‘è¦è²·é€™äº›é†¬æ²¹å’Œç³–ã€‚", char: "char_customer" },
            { type: "talk", speaker: "åº—é•·", text: "å¥½ï¼Œä¸€å…±æ˜¯ 345 å…ƒã€‚", char: "char_customer" },
            { type: "talk", speaker: "æ—ç™½", text: "(å®¢äººéçµ¦æ‚¨ä¸€å¼µ 1000 å…ƒå¤§éˆ”)", char: "char_customer" }, 
            { type: "number_input", text: "è«‹è¼¸å…¥æ‰¾é›¶é‡‘é¡ï¼š", answer: 655, correct: { s: 0, money: 345 }, wrong: { s: 1, money: 0, reaction: {text: "é™³å¤ªå¤ª: å“å‘€æˆ‘è¶•è‘—å›å®¶ç…®é£¯ï¼Œæ²’ç´°çœ‹å•¦ï¼è¬å•¦è€é—†ï¼", speaker: "é™³å¤ªå¤ª"} }, char: "char_customer" },
            { type: "talk", speaker: "é™³å¤ªå¤ª", text: "ç®—å¾—æ²’éŒ¯ï¼Œè¬è¬è€é—†ï¼", char: "char_customer" }, 
            { type: "talk", speaker: "æ—ç™½", text: "(é™³å¤ªå¤ªé–‹å¿ƒåœ°æè‘—é†¬æ²¹å›å®¶ç…®é£¯äº†)", char: null }, 

            // Task 7 (ç±³åº—é˜¿å¼·)
            { type: "scene", bg: "bg_evening", time: "16:00" },
            { type: "talk", speaker: "ç±³åº—é˜¿å¼·", text: "è€é—†ï¼æˆ‘ä¾†é€ç±³äº†ï¼", char: "char_delivery" },
            { type: "talk", speaker: "ç±³åº—é˜¿å¼·", text: "æŠ±æ­‰æœ‰é»é²åˆ°ï¼Œè«‹å•æˆ‘å€‘æ—©ä¸Šé›»è©±è£¡æ˜¯ç´„å¹¾é»ï¼Ÿ", char: "char_delivery" },
            { type: "time_picker", text: "æ—©ä¸Šç´„å®šçš„æ™‚é–“æ˜¯ï¼Ÿ", answer: [16, 4], correct: { s: 0, money: 100, reaction: {text: "ç±³åº—é˜¿å¼·: æ²’éŒ¯ï¼è€é—†è¨˜æ€§çœŸå¥½ï¼Œå‰›å¥½ 4 é»æ•´ã€‚", speaker: "ç±³åº—é˜¿å¼·"} }, wrong: { s: 1, money: 0, reaction: {text: "ç±³åº—é˜¿å¼·: è€é—†... æˆ‘å€‘æ˜¯ç´„ä¸‹åˆ 4 é»æï¼Œç¾åœ¨éƒ½åˆ°äº†ï¼Œä½ è¨˜éŒ¯äº†å§ï¼Ÿ", speaker: "ç±³åº—é˜¿å¼·"} }, char: "char_delivery" }, 
            { type: "talk", speaker: "ç±³åº—é˜¿å¼·", text: "å¥½å•¦æ²’é—œä¿‚ï¼Œé‚£æˆ‘è¶•å¿«å¸è²¨ã€‚", char: "char_delivery" }, 
            { type: "talk", speaker: "æ—ç™½", text: "(ç±³åº—é˜¿å¼·å¸å®Œè²¨é›¢é–‹äº†)", char: null }, 

            // Task 8
            { type: "scene", bg: "bg_night", time: "18:00" },
            { type: "talk", speaker: "åº—é•·", text: "å¤©é»‘äº†ï¼Œè©²æ‹‰éµé–€ä¼‘æ¯äº†ã€‚", char: null },
            { type: "scene", bg: "bg_desktop", time: "18:00" },
            { type: "talk", speaker: "åº—é•·", text: "ç³Ÿç³•ï¼Œæ‰‹ä¸Šçš„é‘°åŒ™ä¸²å‰›æ‰éš¨æ‰‹ä¸€æ”¾ï¼Œä¸çŸ¥é“åœ¨å“ªï¼Ÿ", char: null },
            { type: "choice", text: "è«‹é¸æ“‡å°‹æ‰¾å€åŸŸï¼š", choices: [{ t: "å»æ«ƒå°æ¡Œé¢æ‰¾æ‰¾", s: 0, money: 200, key: true }, { t: "å»å†°ç®±è£¡é¢æ‰¾æ‰¾çœ‹", s: 1, money: 0 }], char: null },
            { type: "key_search", text: "åº—é•·: å•Šï¼åŸä¾†åœ¨é€™è£¡ã€‚(è«‹é»æ“Šé‘°åŒ™)" },
            { type: "talk", speaker: "åº—é•·", text: "ä»Šå¤©çœŸæ˜¯å¿™ç¢Œåˆå……å¯¦çš„ä¸€å¤©å‘¢ã€‚", char: null },
            { type: "end" }
        ];

        let index = 0, riskScore = 0, totalMoney = 0;
        let activeCharIndex = 1;
        let typeWriterTimer = null;
        let isMusicOn = true;
        let speechSynth = window.speechSynthesis;
        let currentUtterance = null;
        
        const dom = {
            bg: document.getElementById('bg-layer'),
            char1: document.getElementById('char-1'),
            char2: document.getElementById('char-2'),
            overlay: document.getElementById('interaction-overlay'),
            title: document.getElementById('interaction-title'),
            titleText: document.getElementById('title-text'),
            content: document.getElementById('interaction-content'),
            dialog: document.getElementById('dialog-area'),
            speakerBox: document.getElementById('speaker-box'),
            speakerName: document.getElementById('speaker-name'),
            text: document.getElementById('dialog-text'),
            hudTime: document.getElementById('game-time'),
            hudMoney: document.getElementById('game-money'),
            key: document.getElementById('key-item'),
            startBtn: document.getElementById('start-btn'),
            musicToggle: document.getElementById('music-toggle')
        };

        const bgm = document.getElementById('bgm');
        
        function toggleMusic() {
            isMusicOn = !isMusicOn;
            const icon = dom.musicToggle.querySelector('i');
            if (isMusicOn) {
                dom.musicToggle.classList.remove('music-off');
                icon.className = 'fas fa-volume-up';
                bgm.play().catch(e=>{});
            } else {
                dom.musicToggle.classList.add('music-off');
                icon.className = 'fas fa-volume-mute';
                bgm.pause();
                if(currentUtterance) speechSynth.cancel();
            }
        }

        bgm.addEventListener('timeupdate', () => {
            if (!isMusicOn) return;
            const t = bgm.currentTime; const d = bgm.duration;
            if (!d) return;
            if (t < 5) bgm.volume = t / 5; 
            else if (t > d - 5) bgm.volume = Math.max(0, (d - t) / 5);
            else bgm.volume = 1.0;
        });

        function speak(text, role) {
            if (!isMusicOn) return; 
            speechSynth.cancel(); 
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'zh-TW';
            const profile = VOICE_PROFILES[role] || { pitch: 1.0, rate: 1.0 };
            u.pitch = profile.pitch;
            u.rate = profile.rate;
            currentUtterance = u;
            speechSynth.speak(u);
        }

        function replayVoice() {
            const scene = SCRIPT[index];
            if(scene && scene.text) speak(scene.text, scene.speaker);
        }

        function speakTitle() {
            const scene = SCRIPT[index];
            if(scene && scene.text) speak(scene.text, "æ—ç™½");
        }

        function speakChoice(text) {
            speak(text, "æ—ç™½");
        }

        window.onload = function() {
            resizeApp(); 
            
            let loadedCount = 0;
            const assetKeys = Object.keys(ASSETS);
            const totalAssets = assetKeys.length;
            const checkProgress = () => {
                loadedCount++;
                const percent = Math.floor((loadedCount / totalAssets) * 100);
                dom.startBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> éŠæˆ²è¼‰å…¥ä¸­ (${percent}%)`;
                if (loadedCount >= totalAssets) {
                    dom.startBtn.innerHTML = "é–‹å§‹ç‡Ÿæ¥­";
                    dom.startBtn.disabled = false;
                    dom.startBtn.classList.add('pulse');
                }
            };
            assetKeys.forEach(key => {
                const img = new Image();
                img.onload = checkProgress; img.onerror = checkProgress; 
                img.src = ASSETS[key];
            });
            bgm.load();
        };

        function startGame() {
            document.getElementById('intro-overlay').style.display = 'none';
            dom.key.src = ASSETS.char_keys; 
            render();
            if(isMusicOn) {
                bgm.volume = 0;
                bgm.play().catch(e => console.log("Audio autoplay blocked"));
            }
        }

        function render() {
            const scene = SCRIPT[index];

            if (scene.type === "scene") {
                dom.bg.style.backgroundImage = `url('${ASSETS[scene.bg]}')`;
                if (scene.bg === "bg_evening") dom.bg.style.filter = "brightness(0.8) sepia(0.3)";
                else if (scene.bg === "bg_night") dom.bg.style.filter = "brightness(0.5) contrast(1.2)";
                else dom.bg.style.filter = "none";
                dom.hudTime.innerText = scene.time;
                dom.char1.className = 'char-img'; dom.char2.className = 'char-img'; 
                index++; render();
                return;
            }

            if (scene.type === "end") { showReport(); return; }

            if (scene.type === "key_search") {
                dom.overlay.style.display = 'none';
                dom.speakerName.innerText = "ç³»çµ±æç¤º";
                typeWriter("è«‹åœ¨ç•«é¢ä¸Šé»æ“Šé‘°åŒ™...", dom.text);
                speak("è«‹åœ¨ç•«é¢ä¸Šé»æ“Šé‘°åŒ™", "æ—ç™½"); 
                dom.key.style.display = 'block';
                dom.key.onclick = () => {
                    dom.key.style.display = 'none';
                    dom.speakerName.innerText = "åº—é•·";
                    typeWriter("æ‰¾åˆ°äº†ï¼åŸä¾†å£“åœ¨æ–‡ä»¶ä¸‹é¢ã€‚", dom.text);
                    speak("æ‰¾åˆ°äº†ï¼åŸä¾†å£“åœ¨æ–‡ä»¶ä¸‹é¢ã€‚", "åº—é•·"); 
                    setTimeout(() => { index++; render(); }, 2000);
                };
                return;
            }

            updateCharacter(scene);

            if (scene.type === 'choice') showChoice(scene);
            else if (scene.type === 'date_input') showDateInput(scene);
            else if (scene.type === 'number_input') showNumberInput(scene);
            else if (scene.type === 'time_picker') showTimePicker(scene); 
            else showTalk(scene);
        }

        function showTalk(scene) {
            dom.overlay.style.display = 'none';
            dom.speakerName.innerText = scene.speaker;
            typeWriter(scene.text, dom.text);
            speak(scene.text, scene.speaker); 
        }

        function showChoice(scene) {
            dom.overlay.style.display = 'flex';
            dom.titleText.innerText = scene.text;
            dom.content.innerHTML = "";
            speak(scene.text, "æ—ç™½"); 

            scene.choices.forEach(opt => {
                const wrapper = document.createElement('div');
                wrapper.style.display = "flex"; wrapper.style.alignItems = "center"; wrapper.style.width="100%";
                const speakBtn = document.createElement('div');
                speakBtn.className = "choice-speak-icon";
                speakBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                speakBtn.onclick = (e) => { e.stopPropagation(); speakChoice(opt.t); };
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.innerHTML = `<span>${opt.t}</span> <i class="fas fa-chevron-right"></i>`;
                btn.onclick = () => {
                    const resultData = { s: opt.s, money: opt.money, reaction: opt.reaction };
                    processResult(resultData, opt.key);
                };
                wrapper.appendChild(speakBtn); wrapper.appendChild(btn); dom.content.appendChild(wrapper);
            });
        }

        function showDateInput(scene) {
            dom.overlay.style.display = 'flex';
            dom.titleText.innerText = scene.text;
            speak(scene.text, "æ—ç™½"); 
            dom.content.innerHTML = `
                <div class="input-group">
                    <select id="yy" class="custom-select"></select>
                    <select id="mm" class="custom-select"></select>
                    <select id="dd" class="custom-select"></select>
                </div>
                <button class="confirm-btn" onclick="checkDate()">ç¢ºèª</button>
            `;
            const now = new Date();
            const y = now.getFullYear(); 
            const yy = document.getElementById('yy'); const mm = document.getElementById('mm'); const dd = document.getElementById('dd');
            [y-1, y, y+1].forEach(yr => { yy.innerHTML += `<option value="${yr}">${yr-1911} å¹´</option>`; });
            yy.value = y;
            for(let i=1; i<=12; i++) mm.innerHTML += `<option value="${i-1}">${i} æœˆ</option>`; mm.value = now.getMonth();
            for(let i=1; i<=31; i++) dd.innerHTML += `<option value="${i}">${i} æ—¥</option>`; dd.value = now.getDate();
            window.checkDate = () => {
                const selY = parseInt(yy.value); const selM = parseInt(mm.value); const selD = parseInt(dd.value);
                const isCorrect = (selY === now.getFullYear() && selM === now.getMonth() && selD === now.getDate());
                handleResult(isCorrect, scene);
            };
        }

        function showNumberInput(scene) {
            dom.overlay.style.display = 'flex';
            dom.titleText.innerText = scene.text;
            speak(scene.text, "æ—ç™½"); 
            dom.content.innerHTML = `
                <div id="numpad-display"></div>
                <div id="numpad">
                    ${[1,2,3,4,5,6,7,8,9].map(n => `<button class="num-btn" onclick="addNum(${n})">${n}</button>`).join('')}
                    <button class="num-btn" onclick="clearNum()">C</button>
                    <button class="num-btn" onclick="addNum(0)">0</button>
                    <button class="num-btn" style="background:#48bb78" onclick="checkNum()">OK</button>
                </div>
            `;
            let val = "";
            const display = document.getElementById('numpad-display');
            window.addNum = (n) => { if(val.length<5) val+=n; display.innerText = val; };
            window.clearNum = () => { val=""; display.innerText = ""; };
            window.checkNum = () => {
                const inputVal = parseInt(val);
                const isCorrect = (inputVal === scene.answer);
                handleResult(isCorrect, scene);
            };
        }

        function showTimePicker(scene) {
            dom.overlay.style.display = 'flex';
            dom.titleText.innerText = scene.text;
            speak(scene.text, "æ—ç™½"); 
            
            dom.content.innerHTML = `
                <div class="time-picker-container">
                    <div class="ampm-toggle">
                        <button class="ampm-btn active" id="btn-pm" onclick="setAmPm('PM')">ä¸‹åˆ</button>
                        <button class="ampm-btn" id="btn-am" onclick="setAmPm('AM')">ä¸Šåˆ</button>
                    </div>
                    <div class="hour-selector">
                        ${[1,2,3,4,5,6,7,8,9,10,11,12].map(h => 
                            `<div class="hour-btn" onclick="selectHour(${h}, this)">${h}</div>`
                        ).join('')}
                    </div>
                </div>
                <button class="confirm-btn" onclick="checkTimePicker()">ç¢ºèª</button>
            `;
            
            let selectedPeriod = 'PM';
            let selectedHour = null;

            window.setAmPm = (p) => {
                selectedPeriod = p;
                document.getElementById('btn-pm').className = p==='PM' ? 'ampm-btn active' : 'ampm-btn';
                document.getElementById('btn-am').className = p==='AM' ? 'ampm-btn active' : 'ampm-btn';
            };

            window.selectHour = (h, el) => {
                selectedHour = h;
                document.querySelectorAll('.hour-btn').forEach(b => b.classList.remove('selected'));
                el.classList.add('selected');
            };

            window.checkTimePicker = () => {
                if(selectedHour === null) return alert("è«‹é¸æ“‡æ™‚é–“");
                let finalH = selectedHour;
                if(selectedPeriod === 'PM' && selectedHour !== 12) finalH += 12;
                if(selectedPeriod === 'AM' && selectedHour === 12) finalH = 0;
                const isCorrect = scene.answer.includes(finalH) || (selectedPeriod === 'PM' && scene.answer.includes(selectedHour));
                handleResult(isCorrect, scene);
            };
        }

        function handleResult(isCorrect, scene) {
            const resultData = isCorrect ? scene.correct : scene.wrong;
            processResult(resultData, false);
        }

        function processResult(data, isKeyTask) {
            riskScore += data.s;
            totalMoney += data.money;
            dom.hudMoney.innerText = totalMoney;
            dom.overlay.style.display = 'none'; 

            if (data.reaction) {
                dom.speakerName.innerText = data.reaction.speaker;
                dom.dialog.style.display = 'flex'; 
                typeWriter(data.reaction.text, dom.text, () => { waitForClick(); });
                speak(data.reaction.text, data.reaction.speaker); 
            } else {
                if (isKeyTask) { index++; dom.overlay.style.display = 'none'; render(); } 
                else { index++; if (SCRIPT[index] && SCRIPT[index].type === 'key_search') index++; dom.overlay.style.display = 'none'; render(); }
            }
        }

        function waitForClick() {
            const handler = () => { dom.dialog.removeEventListener('click', handler); index++; render(); };
            setTimeout(() => dom.dialog.addEventListener('click', handler), 500);
        }

        function updateCharacter(scene) {
            const activeEl = activeCharIndex === 1 ? dom.char1 : dom.char2;
            const nextEl = activeCharIndex === 1 ? dom.char2 : dom.char1;
            if (scene.char && ASSETS[scene.char]) {
                const targetSrc = ASSETS[scene.char];
                if (!activeEl.src.includes(targetSrc) || !activeEl.classList.contains('char-visible')) {
                    if (scene.object) nextEl.classList.add('object-mode'); else nextEl.classList.remove('object-mode');
                    nextEl.src = targetSrc;
                    nextEl.onload = () => { nextEl.classList.add('char-visible'); activeEl.classList.remove('char-visible'); activeCharIndex = activeCharIndex === 1 ? 2 : 1; };
                }
            } else {
                dom.char1.classList.remove('char-visible'); dom.char2.classList.remove('char-visible');
            }
        }

        function typeWriter(text, element, callback) {
            if (typeWriterTimer) clearInterval(typeWriterTimer);
            element.innerText = "";
            let i = 0;
            typeWriterTimer = setInterval(() => {
                element.innerText += text.charAt(i); i++;
                if (i >= text.length) { clearInterval(typeWriterTimer); typeWriterTimer = null; if (callback) callback(); }
            }, 30);
        }

        function advanceStory() {
            if (dom.overlay.style.display === 'flex') return;
            if (document.getElementById('key-item').style.display === 'block') return;
            if (typeWriterTimer) { clearInterval(typeWriterTimer); typeWriterTimer = null; dom.text.innerText = SCRIPT[index].text || ""; return; }
            index++; if (index < SCRIPT.length) render();
        }

        function showReport() {
            document.getElementById('report-overlay').style.display = 'flex';
            document.getElementById('report-money').innerText = `$${totalMoney}`;
            const stamp = document.getElementById('final-stamp');
            const advice = document.getElementById('report-advice');
            const riskLabel = document.getElementById('report-risk');
            speak("ä»Šæ—¥ç‡Ÿé‹çµæŸï¼Œè«‹çœ‹æ‚¨çš„ç‡Ÿé‹å ±å‘Š", "æ—ç™½");

            if (riskScore <= 1) {
                stamp.innerText = "é‡‘ç‰Œåº—é•·"; stamp.style.borderColor = "#f6ad55"; stamp.style.color = "#f6ad55";
                riskLabel.innerText = "S ç´š (å„ªç•°)"; advice.innerText = "å¤ªå²å®³äº†ï¼æ‚¨çš„è¨˜æ†¶åŠ›èˆ‡åˆ¤æ–·åŠ›éƒ½éå¸¸æ¸…æ™°ï¼Œè«‹ç¹¼çºŒä¿æŒé€™æ¨£çš„ç”Ÿæ´»ç¯€å¥ï¼";
            } else if (riskScore <= 3) {
                stamp.innerText = "éŠ€ç‰Œåº—é•·"; stamp.style.borderColor = "#718096"; stamp.style.color = "#718096";
                riskLabel.innerText = "A ç´š (è‰¯å¥½)"; advice.innerText = "è¡¨ç¾ä¸éŒ¯å–”ï¼å¶çˆ¾æœ‰äº›å°å¿˜è¨˜æ˜¯æ­£å¸¸çš„ï¼Œå¤šå‹•è…¦ã€å¤šé‹å‹•å¯ä»¥è®“é ­è…¦æ›´éˆæ´»ã€‚";
            } else {
                stamp.innerText = "éŠ…ç‰Œåº—é•·"; stamp.style.borderColor = "#c53030"; stamp.style.color = "#c53030";
                riskLabel.innerText = "B ç´š (åŠ æ²¹)"; advice.innerText = "æœ€è¿‘æ˜¯ä¸æ˜¯æ¯”è¼ƒç´¯å‘¢ï¼Ÿå»ºè­°æ‰¾æ™‚é–“å»é†«é™¢åšå€‹è©³ç´°æª¢æŸ¥ï¼Œè®“é†«ç”Ÿå¹«æ‚¨ä¿é¤Šä¸€ä¸‹å¤§è…¦å–”ã€‚";
            }
        }
    </script>
</body>
</html>